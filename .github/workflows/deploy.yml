# CI/CD Pipeline for Portfolio Website
# Deploys to Netlify on pushes and PRs to main branch
name: Deploy to Netlify

# Trigger the workflow on pushes and pull requests to the main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    # Run on Ubuntu latest
    runs-on: ubuntu-latest

    steps:
    # Record the start time for calculating build duration
    - name: Record build start time
      run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV

    # Checkout the repository code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Setup Node.js with caching for faster builds
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # Install project dependencies using npm ci for faster, reliable installs
    - name: Install dependencies
      run: npm ci

    # Run linting to ensure code quality
    - name: Run linting
      run: npm run lint

    # Build the project for production
    - name: Build project
      run: npm run build

    # Validate that required secrets are configured
    - name: Check Netlify credentials
      run: |
        if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then
          echo "::error::NETLIFY_AUTH_TOKEN secret is not configured. Please add it in GitHub repository Settings → Secrets and variables → Actions."
          echo "Get your token from: Netlify account → User settings → Applications → Personal access tokens"
          exit 1
        fi
        if [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then
          echo "::error::NETLIFY_SITE_ID secret is not configured. Please add it in GitHub repository Settings → Secrets and variables → Actions."
          echo "Get your Site ID from: Netlify dashboard → Site configuration → General → Site ID"
          exit 1
        fi
        echo "✓ Netlify credentials are configured"

    # Deploy the built site to Netlify
    - name: Deploy to Netlify
      run: |
        # Install Netlify CLI globally
        npm install -g netlify-cli
        # Deploy to production and capture the deployment URL
        DEPLOY_OUTPUT=$(netlify deploy --prod --dir=dist --auth=$NETLIFY_AUTH_TOKEN --site=$NETLIFY_SITE_ID --json)
        DEPLOY_URL=$(echo $DEPLOY_OUTPUT | jq -r '.deploy_url')
        echo "Deployment URL: $DEPLOY_URL"
        echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_ENV
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    # Generate a job summary with deployment details
    - name: Job Summary
      run: |
        BUILD_DURATION=$(( $(date +%s) - $BUILD_START_TIME ))
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment URL**: $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Duration**: $BUILD_DURATION seconds" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit SHA**: $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
